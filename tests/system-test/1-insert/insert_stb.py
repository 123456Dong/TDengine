import sys 
from util.log import *
from util.cases import *
from util.sql import *
from util.dnodes import tdDnodes
from math import inf
import taos

class TDTestCase:
    def caseDescription(self):
        '''
        case1<shenglian zhou>: [TS-3932] insert into stb 
        ''' 
        return
    
    def init(self, conn, logSql, replicaVer=1):
        tdLog.debug("start to execute %s" % __file__)
        tdSql.init(conn.cursor(), True)
        self.conn = conn
        
        
    def restartTaosd(self, index=1, dbname="db"):
        tdDnodes.stop(index)
        tdDnodes.startWithoutSleep(index)
        tdSql.execute(f"use insert_stb")


    def run_normal(self):
        print("running {}".format(__file__))
        tdSql.execute("drop database if exists insert_stb")
        tdSql.execute("create database if not exists insert_stb")
        tdSql.execute('use insert_stb')
        tdSql.execute('create database d1')

        tdSql.execute('create database d2')

        tdSql.execute('use d1;')

        tdSql.execute('create table st(ts timestamp, f int) tags(t int);')

        tdSql.execute("insert into ct1 using st tags(1) values('2021-04-19 00:00:00', 1);")

        tdSql.execute("insert into ct2 using st tags(2) values('2021-04-19 00:00:01', 2);")

        tdSql.execute("insert into ct1 values('2021-04-19 00:00:02', 2);")

        tdSql.execute('use d2;')

        tdSql.execute('create table st(ts timestamp, f int) tags(t int);')

        tdSql.execute("insert into ct1 using st tags(1) values('2021-04-19 00:00:00', 1);")

        tdSql.execute("insert into ct2 using st tags(2) values('2021-04-19 00:00:01', 2);")

        tdSql.execute('create database db1 vgroups 1;')

        tdSql.execute('create table db1.stb (ts timestamp, c1 int, c2 int) tags(t1 int, t2 int);')

        tdSql.execute('use d1;')

        tdSql.execute("insert into st (tbname, ts, f, t) values('ct3', '2021-04-19 08:00:03', 3, 3);")

        tdSql.execute("insert into d1.st (tbname, ts, f) values('ct6', '2021-04-19 08:00:04', 6);")

        tdSql.execute("insert into d1.st (tbname, ts, f) values('ct6', '2021-04-19 08:00:05', 7)('ct8', '2021-04-19 08:00:06', 8);")

        tdSql.execute("insert into d1.st (tbname, ts, f, t) values('ct6', '2021-04-19 08:00:07', 9, 9)('ct8', '2021-04-19 08:00:08', 10, 10);")

        tdSql.execute("insert into d1.st (tbname, ts, f, t) values('ct6', '2021-04-19 08:00:09', 9, 9)('ct8', '2021-04-19 08:00:10', 10, 10) d2.st (tbname, ts, f, t) values('ct6', '2021-04-19 08:00:11', 9, 9)('ct8', '2021-04-19 08:00:12', 10, 10);")

        tdSql.query('select * from d1.st order by ts;')
        tdSql.checkRows(11)
        tdSql.checkData(0, 0, datetime.datetime(2021, 4, 19, 0, 0))
        tdSql.checkData(0, 1, 1)
        tdSql.checkData(0, 2, 1)
        tdSql.checkData(1, 0, datetime.datetime(2021, 4, 19, 0, 0, 1))
        tdSql.checkData(1, 1, 2)
        tdSql.checkData(1, 2, 2)
        tdSql.checkData(2, 0, datetime.datetime(2021, 4, 19, 0, 0, 2))
        tdSql.checkData(2, 1, 2)
        tdSql.checkData(2, 2, 1)
        tdSql.checkData(3, 0, datetime.datetime(2021, 4, 19, 8, 0, 3))
        tdSql.checkData(3, 1, 3)
        tdSql.checkData(3, 2, 3)
        tdSql.checkData(4, 0, datetime.datetime(2021, 4, 19, 8, 0, 4))
        tdSql.checkData(4, 1, 6)
        tdSql.checkData(4, 2, None)
        tdSql.checkData(5, 0, datetime.datetime(2021, 4, 19, 8, 0, 5))
        tdSql.checkData(5, 1, 7)
        tdSql.checkData(5, 2, None)
        tdSql.checkData(6, 0, datetime.datetime(2021, 4, 19, 8, 0, 6))
        tdSql.checkData(6, 1, 8)
        tdSql.checkData(6, 2, None)
        tdSql.checkData(7, 0, datetime.datetime(2021, 4, 19, 8, 0, 7))
        tdSql.checkData(7, 1, 9)
        tdSql.checkData(7, 2, None)
        tdSql.checkData(8, 0, datetime.datetime(2021, 4, 19, 8, 0, 8))
        tdSql.checkData(8, 1, 10)
        tdSql.checkData(8, 2, None)
        tdSql.checkData(9, 0, datetime.datetime(2021, 4, 19, 8, 0, 9))
        tdSql.checkData(9, 1, 9)
        tdSql.checkData(9, 2, None)
        tdSql.checkData(10, 0, datetime.datetime(2021, 4, 19, 8, 0, 10))
        tdSql.checkData(10, 1, 10)
        tdSql.checkData(10, 2, None)

        tdSql.query('select * from d2.st order by ts;')
        tdSql.checkRows(4)
        tdSql.checkData(0, 0, datetime.datetime(2021, 4, 19, 0, 0))
        tdSql.checkData(0, 1, 1)
        tdSql.checkData(0, 2, 1)
        tdSql.checkData(1, 0, datetime.datetime(2021, 4, 19, 0, 0, 1))
        tdSql.checkData(1, 1, 2)
        tdSql.checkData(1, 2, 2)
        tdSql.checkData(2, 0, datetime.datetime(2021, 4, 19, 8, 0, 11))
        tdSql.checkData(2, 1, 9)
        tdSql.checkData(2, 2, 9)
        tdSql.checkData(3, 0, datetime.datetime(2021, 4, 19, 8, 0, 12))
        tdSql.checkData(3, 1, 10)
        tdSql.checkData(3, 2, 10)

        tdSql.execute("insert into d2.st(ts, f, tbname) values('2021-04-19 08:00:13', 1, 'ct1') d1.ct1 values('2021-04-19 08:00:14', 1);")

        tdSql.query('select * from d1.st order by ts;')
        tdSql.checkRows(12)
        tdSql.checkData(0, 0, datetime.datetime(2021, 4, 19, 0, 0))
        tdSql.checkData(0, 1, 1)
        tdSql.checkData(0, 2, 1)
        tdSql.checkData(1, 0, datetime.datetime(2021, 4, 19, 0, 0, 1))
        tdSql.checkData(1, 1, 2)
        tdSql.checkData(1, 2, 2)
        tdSql.checkData(2, 0, datetime.datetime(2021, 4, 19, 0, 0, 2))
        tdSql.checkData(2, 1, 2)
        tdSql.checkData(2, 2, 1)
        tdSql.checkData(3, 0, datetime.datetime(2021, 4, 19, 8, 0, 3))
        tdSql.checkData(3, 1, 3)
        tdSql.checkData(3, 2, 3)
        tdSql.checkData(4, 0, datetime.datetime(2021, 4, 19, 8, 0, 4))
        tdSql.checkData(4, 1, 6)
        tdSql.checkData(4, 2, None)
        tdSql.checkData(5, 0, datetime.datetime(2021, 4, 19, 8, 0, 5))
        tdSql.checkData(5, 1, 7)
        tdSql.checkData(5, 2, None)
        tdSql.checkData(6, 0, datetime.datetime(2021, 4, 19, 8, 0, 6))
        tdSql.checkData(6, 1, 8)
        tdSql.checkData(6, 2, None)
        tdSql.checkData(7, 0, datetime.datetime(2021, 4, 19, 8, 0, 7))
        tdSql.checkData(7, 1, 9)
        tdSql.checkData(7, 2, None)
        tdSql.checkData(8, 0, datetime.datetime(2021, 4, 19, 8, 0, 8))
        tdSql.checkData(8, 1, 10)
        tdSql.checkData(8, 2, None)
        tdSql.checkData(9, 0, datetime.datetime(2021, 4, 19, 8, 0, 9))
        tdSql.checkData(9, 1, 9)
        tdSql.checkData(9, 2, None)
        tdSql.checkData(10, 0, datetime.datetime(2021, 4, 19, 8, 0, 10))
        tdSql.checkData(10, 1, 10)
        tdSql.checkData(10, 2, None)
        tdSql.checkData(11, 0, datetime.datetime(2021, 4, 19, 8, 0, 14))
        tdSql.checkData(11, 1, 1)
        tdSql.checkData(11, 2, 1)

        tdSql.query('select * from d2.st order by ts;')
        tdSql.checkRows(5)
        tdSql.checkData(0, 0, datetime.datetime(2021, 4, 19, 0, 0))
        tdSql.checkData(0, 1, 1)
        tdSql.checkData(0, 2, 1)
        tdSql.checkData(1, 0, datetime.datetime(2021, 4, 19, 0, 0, 1))
        tdSql.checkData(1, 1, 2)
        tdSql.checkData(1, 2, 2)
        tdSql.checkData(2, 0, datetime.datetime(2021, 4, 19, 8, 0, 11))
        tdSql.checkData(2, 1, 9)
        tdSql.checkData(2, 2, 9)
        tdSql.checkData(3, 0, datetime.datetime(2021, 4, 19, 8, 0, 12))
        tdSql.checkData(3, 1, 10)
        tdSql.checkData(3, 2, 10)
        tdSql.checkData(4, 0, datetime.datetime(2021, 4, 19, 8, 0, 13))
        tdSql.checkData(4, 1, 1)
        tdSql.checkData(4, 2, None)
    
    def run_insert_stb(self):
        print("running {}".format('insert_stb'))
        self.conn.select_db('insert_stb')
        tdSql.execute('create table stb1 (ts timestamp, c1 bool, c2 tinyint, c3 smallint, c4 int, c5 bigint, c6 float, c7 double, c8 binary(10), c9 nchar(10), c10 tinyint unsigned, c11 smallint unsigned, c12 int unsigned, c13 bigint unsigned) TAGS(t1 int, t2 binary(10), t3 double);')

        tdSql.execute('insert into stb1(ts,c1,c2,c3,c4,c5,c6,c7,c8,c9,c10,c11,c12,c13,t1,t2,t3,tbname) values (\'2021-11-11 09:00:00\',true,1,1,1,1,1,1,"123","1234",1,1,1,1, 1, \'1\', 1.0, \'tb1\');')

        tdSql.execute("insert into stb1(ts,c1,c2,c3,c4,c5,c6,c7,c8,c9,c10,c11,c12,c13,t1,t2,t3,tbname) values ('2021-11-11 09:00:01',true,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL, 2, '2', 2.0, 'tb1');")

        tdSql.execute('insert into stb1(ts,c1,c2,c3,c4,c5,c6,c7,c8,c9,c10,c11,c12,c13,t1,t2,t3,tbname) values (\'2021-11-11 09:00:02\',true,2,NULL,2,NULL,2,NULL,"234",NULL,2,NULL,2,NULL, 2, \'2\', 2.0, \'tb2\');')

        tdSql.execute('insert into stb1(ts,c1,c2,c3,c4,c5,c6,c7,c8,c9,c10,c11,c12,c13,t1,t2,t3,tbname) values (\'2021-11-11 09:00:03\',false,NULL,3,NULL,3,NULL,3,NULL,"3456",NULL,3,NULL,3, 3, \'3\', 3.0, \'tb3\');')

        tdSql.execute('insert into stb1(ts,c1,c2,c3,c4,c5,c6,c7,c8,c9,c10,c11,c12,c13,t1,t2,t3,tbname) values (\'2021-11-11 09:00:04\',true,4,4,4,4,4,4,"456","4567",4,4,4,4, 4, \'4.0\', 4.0, \'tb4\');')

        tdSql.execute('insert into stb1(ts,c1,c2,c3,c4,c5,c6,c7,c8,c9,c10,c11,c12,c13,t1,t2,t3,tbname) values (\'2021-11-11 09:00:05\',true,127,32767,2147483647,9223372036854775807,3.402823466e+38,1.79769e+308,"567","5678",254,65534,4294967294,9223372036854775807, 5, \'5\', 5, \'max\' );')

        tdSql.execute('insert into stb1(ts,c1,c2,c3,c4,c5,c6,c7,c8,c9,c10,c11,c12,c13,t1,t2,t3,tbname) values (\'2021-11-11 09:00:06\',true,-127,-32767,-2147483647,-9223372036854775807,-3.402823466e+38,-1.79769e+308,"678","6789",0,0,0,0, 6, \'6\', 6, \'min\');')

        tdSql.execute('insert into stb1(ts,c1,c2,c3,c4,c5,c6,c7,c8,c9,c10,c11,c12,c13,tbname,t1,t2,t3) values (\'2021-11-11 09:00:07\',true,-127,-32767,-2147483647,-9223372036854775807,-3.402823466e+38,-1.79769e+308,"678","6789",0,0,0,0, \'min\', 6, \'6\', 6);')

        tdSql.query('select tbname,* from stb1 order by ts;')
        tdSql.checkRows(8)
        tdSql.checkData(0, 0, 'tb1')
        tdSql.checkData(0, 1, datetime.datetime(2021, 11, 11, 9, 0))
        tdSql.checkData(0, 2, True)
        tdSql.checkData(0, 3, 1)
        tdSql.checkData(0, 4, 1)
        tdSql.checkData(0, 5, 1)
        tdSql.checkData(0, 6, 1)
        tdSql.checkData(0, 7, 1.0)
        tdSql.checkData(0, 8, 1.0)
        tdSql.checkData(0, 9, '123')
        tdSql.checkData(0, 10, '1234')
        tdSql.checkData(0, 11, 1)
        tdSql.checkData(0, 12, 1)
        tdSql.checkData(0, 13, 1)
        tdSql.checkData(0, 14, 1)
        tdSql.checkData(0, 15, 1)
        tdSql.checkData(0, 16, '1')
        tdSql.checkData(0, 17, 1.0)
        tdSql.checkData(1, 0, 'tb1')
        tdSql.checkData(1, 1, datetime.datetime(2021, 11, 11, 9, 0, 1))
        tdSql.checkData(1, 2, True)
        tdSql.checkData(1, 3, None)
        tdSql.checkData(1, 4, None)
        tdSql.checkData(1, 5, None)
        tdSql.checkData(1, 6, None)
        tdSql.checkData(1, 7, None)
        tdSql.checkData(1, 8, None)
        tdSql.checkData(1, 9, None)
        tdSql.checkData(1, 10, None)
        tdSql.checkData(1, 11, None)
        tdSql.checkData(1, 12, None)
        tdSql.checkData(1, 13, None)
        tdSql.checkData(1, 14, None)
        tdSql.checkData(1, 15, 1)
        tdSql.checkData(1, 16, '1')
        tdSql.checkData(1, 17, 1.0)
        tdSql.checkData(2, 0, 'tb2')
        tdSql.checkData(2, 1, datetime.datetime(2021, 11, 11, 9, 0, 2))
        tdSql.checkData(2, 2, True)
        tdSql.checkData(2, 3, 2)
        tdSql.checkData(2, 4, None)
        tdSql.checkData(2, 5, 2)
        tdSql.checkData(2, 6, None)
        tdSql.checkData(2, 7, 2.0)
        tdSql.checkData(2, 8, None)
        tdSql.checkData(2, 9, '234')
        tdSql.checkData(2, 10, None)
        tdSql.checkData(2, 11, 2)
        tdSql.checkData(2, 12, None)
        tdSql.checkData(2, 13, 2)
        tdSql.checkData(2, 14, None)
        tdSql.checkData(2, 15, 2)
        tdSql.checkData(2, 16, '2')
        tdSql.checkData(2, 17, 2.0)
        tdSql.checkData(3, 0, 'tb3')
        tdSql.checkData(3, 1, datetime.datetime(2021, 11, 11, 9, 0, 3))
        tdSql.checkData(3, 2, False)
        tdSql.checkData(3, 3, None)
        tdSql.checkData(3, 4, 3)
        tdSql.checkData(3, 5, None)
        tdSql.checkData(3, 6, 3)
        tdSql.checkData(3, 7, None)
        tdSql.checkData(3, 8, 3.0)
        tdSql.checkData(3, 9, None)
        tdSql.checkData(3, 10, '3456')
        tdSql.checkData(3, 11, None)
        tdSql.checkData(3, 12, 3)
        tdSql.checkData(3, 13, None)
        tdSql.checkData(3, 14, 3)
        tdSql.checkData(3, 15, 3)
        tdSql.checkData(3, 16, '3')
        tdSql.checkData(3, 17, 3.0)
        tdSql.checkData(4, 0, 'tb4')
        tdSql.checkData(4, 1, datetime.datetime(2021, 11, 11, 9, 0, 4))
        tdSql.checkData(4, 2, True)
        tdSql.checkData(4, 3, 4)
        tdSql.checkData(4, 4, 4)
        tdSql.checkData(4, 5, 4)
        tdSql.checkData(4, 6, 4)
        tdSql.checkData(4, 7, 4.0)
        tdSql.checkData(4, 8, 4.0)
        tdSql.checkData(4, 9, '456')
        tdSql.checkData(4, 10, '4567')
        tdSql.checkData(4, 11, 4)
        tdSql.checkData(4, 12, 4)
        tdSql.checkData(4, 13, 4)
        tdSql.checkData(4, 14, 4)
        tdSql.checkData(4, 15, 4)
        tdSql.checkData(4, 16, '4.0')
        tdSql.checkData(4, 17, 4.0)
        tdSql.checkData(5, 0, 'max')
        tdSql.checkData(5, 1, datetime.datetime(2021, 11, 11, 9, 0, 5))
        tdSql.checkData(5, 2, True)
        tdSql.checkData(5, 3, 127)
        tdSql.checkData(5, 4, 32767)
        tdSql.checkData(5, 5, 2147483647)
        tdSql.checkData(5, 6, 9223372036854775807)
        tdSql.checkData(5, 7, 3.4028234663852886e+38)
        tdSql.checkData(5, 8, 1.79769e+308)
        tdSql.checkData(5, 9, '567')
        tdSql.checkData(5, 10, '5678')
        tdSql.checkData(5, 11, 254)
        tdSql.checkData(5, 12, 65534)
        tdSql.checkData(5, 13, 4294967294)
        tdSql.checkData(5, 14, 9223372036854775807)
        tdSql.checkData(5, 15, 5)
        tdSql.checkData(5, 16, '5')
        tdSql.checkData(5, 17, 5.0)
        tdSql.checkData(6, 0, 'min')
        tdSql.checkData(6, 1, datetime.datetime(2021, 11, 11, 9, 0, 6))
        tdSql.checkData(6, 2, True)
        tdSql.checkData(6, 3, -127)
        tdSql.checkData(6, 4, -32767)
        tdSql.checkData(6, 5, -2147483647)
        tdSql.checkData(6, 6, -9223372036854775807)
        tdSql.checkData(6, 7, -3.4028234663852886e+38)
        tdSql.checkData(6, 8, -1.79769e+308)
        tdSql.checkData(6, 9, '678')
        tdSql.checkData(6, 10, '6789')
        tdSql.checkData(6, 11, 0)
        tdSql.checkData(6, 12, 0)
        tdSql.checkData(6, 13, 0)
        tdSql.checkData(6, 14, 0)
        tdSql.checkData(6, 15, 6)
        tdSql.checkData(6, 16, '6')
        tdSql.checkData(6, 17, 6.0)
        tdSql.checkData(7, 0, 'min')
        tdSql.checkData(7, 1, datetime.datetime(2021, 11, 11, 9, 0, 7))
        tdSql.checkData(7, 2, True)
        tdSql.checkData(7, 3, -127)
        tdSql.checkData(7, 4, -32767)
        tdSql.checkData(7, 5, -2147483647)
        tdSql.checkData(7, 6, -9223372036854775807)
        tdSql.checkData(7, 7, -3.4028234663852886e+38)
        tdSql.checkData(7, 8, -1.79769e+308)
        tdSql.checkData(7, 9, '678')
        tdSql.checkData(7, 10, '6789')
        tdSql.checkData(7, 11, 0)
        tdSql.checkData(7, 12, 0)
        tdSql.checkData(7, 13, 0)
        tdSql.checkData(7, 14, 0)
        tdSql.checkData(7, 15, 6)
        tdSql.checkData(7, 16, '6')
        tdSql.checkData(7, 17, 6.0)

    def run_stmt_error(self):
        conn = self.conn
        conn.select_db('insert_stb')
        conn.execute('create table stb9(ts timestamp, f int) tags (t int)')
        try:
            stmt = conn.statement("insert into stb9(tbname, f, t) values('ctb91', 1, ?)")
            params = taos.new_bind_params(1)
            params[0].int(1)
            stmt.bind_param(params)
            stmt.execute()
            result = stmt.use_result()
        except Exception as err:
            print(str(err))    
        
        
    def run(self):
        self.run_normal()
        self.run_insert_stb()
        self.run_stmt_error()
        
        
    def stop(self):
        tdSql.close()
        tdLog.success("%s successfully executed" % __file__)

tdCases.addWindows(__file__, TDTestCase())
tdCases.addLinux(__file__, TDTestCase())
