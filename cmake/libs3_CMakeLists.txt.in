# libs3

set(s3_flags "${CMAKE_C_FLAGS} -O3 -Iinc -I$ENV{HOME}/.cos-local.1/include -Iinc ")

set(SED_CMD "s/CFLAGS += -Wall -Werror/CFLAGS += -I$ENV{HOME}/.cos-local.1/include /")

function(update_cflags)
    file(READ "GNUmakefile" S3_CONTENT)
    string(REPLACE "CFLAGS += -Wall -Werror" "CFLAGS += -I$ENV{HOME}/.cos-local.1/include " S3_CONTENT "${S3_CONTENT}")
    file(WRITE "GNUmakefile" "${S3_CONTENT}")
endfunction(update_cflags)

ExternalProject_Add(libs3
        GIT_REPOSITORY https://github.com/bji/libs3
	#GIT_TAG v5.0.16
	DEPENDS curl
        SOURCE_DIR "${TD_CONTRIB_DIR}/libs3"
        #BINARY_DIR ""
        BUILD_IN_SOURCE TRUE
        BUILD_ALWAYS 1
	UPDATE_COMMAND ""
	#sed_cmd "s/CFLAGS += -Wall -Werror/CFLAGS += -I$ENV{HOME}/.cos-local.1/include /"
	CONFIGURE_COMMAND cp ${TD_SUPPORT_DIR}/libs3.GNUmakefile GNUmakefile &&  sed -i "s|CFLAGS += -Wall -Werror|CFLAGS += -I'$ENV{HOME}/.cos-local.1/include' -L'$ENV{HOME}/.cos-local.1/lib' |" ./GNUmakefile
        #BUILD_COMMAND make CFLAGS=${s3_flags} DESTDIR=$ENV{HOME}/.cos-local.1 build/lib/libs3.a
        #BUILD_COMMAND make DESTDIR="$ENV{HOME}/.cos-local.1" build/lib/libs3.a
        BUILD_COMMAND make build/lib/libs3.a
        INSTALL_COMMAND make install_static
        TEST_COMMAND ""
)
